<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Work Louder Micro — LED Control</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: #111;
    color: #eee;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
    padding: 2rem;
  }
  h1 { font-size: 1.2rem; font-weight: 500; color: #888; margin-bottom: 2rem; }

  .keyboard {
    display: grid;
    grid-template-columns: repeat(4, 80px);
    grid-template-rows: repeat(4, 80px);
    gap: 6px;
    margin-bottom: 2rem;
  }
  .key {
    border-radius: 10px;
    border: 2px solid #333;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.15s;
    position: relative;
    font-size: 0.75rem;
    color: #666;
    user-select: none;
  }
  .key:hover { border-color: #555; transform: scale(1.04); }
  .key.on { border-color: #de7356; }
  .key.blinking { animation: blink-border 1s infinite; }
  .key.no-led {
    border: 2px dashed #222;
    cursor: default;
    color: #333;
  }
  .key.no-led:hover { transform: none; border-color: #222; }
  .key .label { font-size: 0.65rem; color: #555; margin-top: 4px; }
  .key .led-id { font-size: 1rem; font-weight: 600; color: #aaa; }
  .key.on .led-id { color: #fff; }

  @keyframes blink-border {
    0%, 100% { border-color: #de7356; }
    50% { border-color: #333; }
  }

  .underglow {
    width: 342px;
    height: 40px;
    border-radius: 12px;
    border: 2px solid #333;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    margin-bottom: 2rem;
    font-size: 0.8rem;
    color: #666;
    transition: all 0.15s;
  }
  .underglow:hover { border-color: #555; }
  .underglow.on { border-color: #de7356; }

  .controls {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    width: 342px;
  }
  .control-row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  .control-row label {
    font-size: 0.8rem;
    color: #888;
    min-width: 80px;
  }
  input[type="color"] {
    -webkit-appearance: none;
    width: 40px;
    height: 30px;
    border: 1px solid #444;
    border-radius: 6px;
    background: none;
    cursor: pointer;
  }
  input[type="color"]::-webkit-color-swatch-wrapper { padding: 2px; }
  input[type="color"]::-webkit-color-swatch { border-radius: 4px; border: none; }

  input[type="range"] {
    flex: 1;
    accent-color: #de7356;
  }
  .speed-val { font-size: 0.75rem; color: #666; min-width: 50px; text-align: right; }

  .presets {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  .preset {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: 2px solid #333;
    cursor: pointer;
    transition: all 0.15s;
  }
  .preset:hover { transform: scale(1.15); border-color: #666; }
  .preset.active { border-color: #fff; }

  .buttons {
    display: flex;
    gap: 8px;
    margin-top: 0.5rem;
  }
  button {
    flex: 1;
    padding: 8px 16px;
    border-radius: 8px;
    border: 1px solid #333;
    background: #1a1a1a;
    color: #ccc;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.15s;
  }
  button:hover { background: #252525; border-color: #555; }

  .mode-toggle {
    display: flex;
    gap: 4px;
    background: #1a1a1a;
    border-radius: 8px;
    padding: 3px;
    border: 1px solid #333;
  }
  .mode-btn {
    padding: 6px 14px;
    border-radius: 6px;
    border: none;
    background: transparent;
    color: #888;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.15s;
  }
  .mode-btn.active { background: #333; color: #eee; }
</style>
</head>
<body>

<h1>Work Louder Micro — LED Control</h1>

<div class="keyboard" id="keyboard"></div>

<div class="underglow" id="underglow" onclick="toggleUnderglow()">
  underglow (8 LEDs)
</div>

<div class="controls">
  <div class="control-row">
    <label>Color</label>
    <input type="color" id="colorPicker" value="#de7356">
    <div class="presets" id="presets"></div>
  </div>

  <div class="control-row">
    <label>Mode</label>
    <div class="mode-toggle">
      <div class="mode-btn active" onclick="setMode('color')" id="mode-color">Color</div>
      <div class="mode-btn" onclick="setMode('blink')" id="mode-blink">Blink</div>
      <div class="mode-btn" onclick="setMode('off')" id="mode-off">Off</div>
    </div>
  </div>

  <div class="control-row">
    <label>Blink speed</label>
    <input type="range" id="blinkSpeed" min="100" max="2000" value="500" step="50">
    <span class="speed-val" id="speedVal">500ms</span>
  </div>

  <div class="buttons">
    <button onclick="allOn()">All on</button>
    <button onclick="allOff()">All off</button>
    <button onclick="allBlink()">All blink</button>
    <button onclick="restore()">Restore default</button>
  </div>
</div>

<script>
const api = (path, body) => fetch(path, {
  method: "POST",
  headers: {"Content-Type": "application/json"},
  body: JSON.stringify(body),
});

// LED layout: [row][col] → led index, null = no LED
const layout = [
  [null, 10, 11, null],
  [9, 8, 7, 6],
  [2, 3, 4, 5],
  [null, 1, 0, null],
];

const labels = [
  ["encoder", "", "", "encoder"],
  ["", "", "", ""],
  ["", "", "", ""],
  ["(no LED)", "", "", "(no LED)"],
];

const presetColors = [
  "#de7356", "#ff0000", "#ff8800", "#ffff00",
  "#00ff00", "#00ffff", "#0055ff", "#aa00ff",
  "#ff00ff", "#ffffff",
];

// State
const ledState = {};  // idx → {on, blink, h, s, v}
let underglowOn = false;
let currentMode = "color"; // color, blink, off
let currentColor = {h: 9, s: 255, v: 200};

// Convert hex to QMK HSV (H: 0-255, S: 0-255, V: 0-255)
function hexToHsv(hex) {
  const r = parseInt(hex.slice(1, 3), 16) / 255;
  const g = parseInt(hex.slice(3, 5), 16) / 255;
  const b = parseInt(hex.slice(5, 7), 16) / 255;
  const max = Math.max(r, g, b), min = Math.min(r, g, b);
  const d = max - min;
  let h = 0;
  if (d !== 0) {
    if (max === r) h = ((g - b) / d + 6) % 6;
    else if (max === g) h = (b - r) / d + 2;
    else h = (r - g) / d + 4;
    h /= 6;
  }
  const s = max === 0 ? 0 : d / max;
  return {
    h: Math.round(h * 255),
    s: Math.round(s * 255),
    v: Math.round(max * 255),
  };
}

function hsvToHex(h, s, v) {
  const hh = (h / 255) * 360;
  const ss = s / 255;
  const vv = v / 255;
  const c = vv * ss;
  const x = c * (1 - Math.abs((hh / 60) % 2 - 1));
  const m = vv - c;
  let r, g, b;
  if (hh < 60) [r, g, b] = [c, x, 0];
  else if (hh < 120) [r, g, b] = [x, c, 0];
  else if (hh < 180) [r, g, b] = [0, c, x];
  else if (hh < 240) [r, g, b] = [0, x, c];
  else if (hh < 300) [r, g, b] = [x, 0, c];
  else [r, g, b] = [c, 0, x];
  const toHex = n => Math.round((n + m) * 255).toString(16).padStart(2, "0");
  return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
}

// Build keyboard grid
const kb = document.getElementById("keyboard");
for (let row = 0; row < 4; row++) {
  for (let col = 0; col < 4; col++) {
    const idx = layout[row][col];
    const el = document.createElement("div");
    el.className = "key" + (idx === null ? " no-led" : "");

    if (idx !== null) {
      el.innerHTML = `<span class="led-id">${idx}</span>`;
      el.dataset.idx = idx;
      el.onclick = () => toggleKey(idx);
      ledState[idx] = {on: false, blink: false, ...currentColor};
    } else {
      el.innerHTML = `<span class="label">${labels[row][col]}</span>`;
    }
    kb.appendChild(el);
  }
}

// Build presets
const presetsEl = document.getElementById("presets");
presetColors.forEach((hex, i) => {
  const el = document.createElement("div");
  el.className = "preset" + (i === 0 ? " active" : "");
  el.style.background = hex;
  el.onclick = () => {
    document.querySelectorAll(".preset").forEach(p => p.classList.remove("active"));
    el.classList.add("active");
    document.getElementById("colorPicker").value = hex;
    currentColor = hexToHsv(hex);
  };
  presetsEl.appendChild(el);
});

document.getElementById("colorPicker").addEventListener("input", (e) => {
  currentColor = hexToHsv(e.target.value);
  document.querySelectorAll(".preset").forEach(p => p.classList.remove("active"));
});

// Blink speed
const speedSlider = document.getElementById("blinkSpeed");
const speedVal = document.getElementById("speedVal");
speedSlider.addEventListener("input", () => {
  const ms = parseInt(speedSlider.value);
  speedVal.textContent = ms + "ms";
  api("/api/blink-speed", {ms});
});

function setMode(mode) {
  currentMode = mode;
  document.querySelectorAll(".mode-btn").forEach(b => b.classList.remove("active"));
  document.getElementById("mode-" + mode).classList.add("active");
}

function updateKeyEl(idx) {
  const el = document.querySelector(`[data-idx="${idx}"]`);
  if (!el) return;
  const st = ledState[idx];
  el.classList.toggle("on", st.on);
  el.classList.toggle("blinking", st.blink);
  if (st.on) {
    const hex = hsvToHex(st.h, st.s, st.v);
    el.style.background = hex + "33";
    el.style.boxShadow = `0 0 20px ${hex}44`;
  } else {
    el.style.background = "";
    el.style.boxShadow = "";
  }
}

function toggleKey(idx) {
  const st = ledState[idx];

  if (currentMode === "off") {
    st.on = false;
    st.blink = false;
    api("/api/blink", {idx, enable: false});
    api("/api/led", {idx, h: 0, s: 0, v: 0});
  } else if (currentMode === "blink") {
    if (!st.on) {
      st.on = true;
      st.h = currentColor.h;
      st.s = currentColor.s;
      st.v = currentColor.v;
      api("/api/led", {idx, ...currentColor});
    }
    st.blink = !st.blink;
    api("/api/blink", {idx, enable: st.blink});
  } else {
    // color mode — toggle on/off with current color
    if (st.on && st.h === currentColor.h && st.s === currentColor.s && st.v === currentColor.v) {
      st.on = false;
      st.blink = false;
      api("/api/blink", {idx, enable: false});
      api("/api/led", {idx, h: 0, s: 0, v: 0});
    } else {
      st.on = true;
      st.h = currentColor.h;
      st.s = currentColor.s;
      st.v = currentColor.v;
      api("/api/led", {idx, ...currentColor});
    }
  }
  updateKeyEl(idx);
}

function toggleUnderglow() {
  underglowOn = !underglowOn;
  const ug = document.getElementById("underglow");
  if (underglowOn) {
    api("/api/underglow", currentColor);
    ug.classList.add("on");
    const hex = hsvToHex(currentColor.h, currentColor.s, currentColor.v);
    ug.style.background = hex + "33";
    ug.style.boxShadow = `0 0 30px ${hex}44`;
  } else {
    api("/api/underglow", {h: 0, s: 0, v: 0});
    ug.classList.remove("on");
    ug.style.background = "";
    ug.style.boxShadow = "";
  }
}

function allOn() {
  api("/api/all", currentColor);
  for (const idx in ledState) {
    ledState[idx].on = true;
    ledState[idx].h = currentColor.h;
    ledState[idx].s = currentColor.s;
    ledState[idx].v = currentColor.v;
    updateKeyEl(idx);
  }
}

function allOff() {
  api("/api/all", {h: 0, s: 0, v: 0});
  for (const idx in ledState) {
    ledState[idx].on = false;
    ledState[idx].blink = false;
    api("/api/blink", {idx: parseInt(idx), enable: false});
    updateKeyEl(idx);
  }
}

function allBlink() {
  for (const idx in ledState) {
    const i = parseInt(idx);
    if (!ledState[idx].on) {
      ledState[idx].on = true;
      ledState[idx].h = currentColor.h;
      ledState[idx].s = currentColor.s;
      ledState[idx].v = currentColor.v;
      api("/api/led", {idx: i, ...currentColor});
    }
    ledState[idx].blink = true;
    api("/api/blink", {idx: i, enable: true});
    updateKeyEl(idx);
  }
}

function restore() {
  api("/api/restore", {});
  for (const idx in ledState) {
    ledState[idx].on = false;
    ledState[idx].blink = false;
    updateKeyEl(idx);
  }
  underglowOn = false;
  const ug = document.getElementById("underglow");
  ug.classList.remove("on");
  ug.style.background = "";
  ug.style.boxShadow = "";
}

// Init: enter direct mode
api("/api/init", {});
</script>
</body>
</html>
